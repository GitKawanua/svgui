{"version":3,"file":"sw.js","sources":["../src/js/utils/storage.js","../src/js/sw/index.js"],"sourcesContent":["export let idbKeyval = (() => {\n  let db;\n\n  function getDB() {\n    if (!db) {\n      db = new Promise((resolve, reject) => {\n        const openreq = indexedDB.open('svgo-keyval', 1);\n\n        openreq.onerror = () => {\n          reject(openreq.error);\n        };\n\n        openreq.onupgradeneeded = () => {\n          // First time setup: create an empty object store\n          openreq.result.createObjectStore('keyval');\n        };\n\n        openreq.onsuccess = () => {\n          resolve(openreq.result);\n        };\n      });\n    }\n    return db;\n  }\n\n  async function withStore(type, callback) {\n    const db = await getDB();\n    return new Promise((resolve, reject) => {\n      const transaction = db.transaction('keyval', type);\n      transaction.oncomplete = () => resolve();\n      transaction.onerror = () => reject(transaction.error);\n      callback(transaction.objectStore('keyval'));\n    });\n  }\n\n  return {\n    async get(key) {\n      let req;\n      await withStore('readonly', store => {\n        req = store.get(key);\n      });\n      return req.result;\n    },\n    set(key, value) {\n      return withStore('readwrite', store => {\n        store.put(value, key);\n      });\n    },\n    delete(key) {\n      return withStore('readwrite', store => {\n        store.delete(key);\n      });\n    }\n  };\n})();\n\n// iOS add-to-homescreen is missing IDB, or at least it used to.\n// I haven't tested this in a while.\nif (!self.indexedDB) {\n  idbKeyval = {\n    get: key => Promise.resolve(localStorage.getItem(key)),\n    set: (key, val) => Promise.resolve(localStorage.setItem(key, val)),\n    delete: key => Promise.resolve(localStorage.removeItem(key))\n  };\n}\n","/* globals SVGOMG_VERSION:false */\n\nimport {idbKeyval as storage} from '../utils/storage.js';\n\nconst version = SVGOMG_VERSION;\nconst cachePrefix = 'svgomg-';\nconst staticCacheName = `${cachePrefix}static-${version}`;\nconst fontCacheName = `${cachePrefix}fonts`;\nconst expectedCaches = [staticCacheName, fontCacheName];\n\naddEventListener('install', event => {\n  event.waitUntil((async () => {\n    const activeVersionPromise = storage.get('active-version');\n    const cache = await caches.open(staticCacheName);\n\n    await cache.addAll([\n      './',\n      'imgs/icon.png',\n      'all.css',\n      'js/gzip-worker.js',\n      'js/page.js',\n      'js/prism-worker.js',\n      'js/svgo-worker.js',\n      'changelog.json',\n      'https://fonts.googleapis.com/css?family=Roboto:400,700%7CInconsolata'\n    ]);\n\n    const activeVersion = await activeVersionPromise;\n\n    // If it's a major version change, don't skip waiting\n    if (!activeVersion || activeVersion.split('.')[0] === version.split('.')[0]) {\n      self.skipWaiting();\n    }\n  })());\n});\n\naddEventListener('activate', event => {\n  event.waitUntil((async () => {\n    // remove caches beginning \"svgomg-\" that aren't in expectedCaches\n    for (const cacheName of await caches.keys()) {\n      if (!cacheName.startsWith(cachePrefix)) continue;\n      if (!expectedCaches.includes(cacheName)) await caches.delete(cacheName);\n    }\n\n    await storage.set('active-version', version);\n  })());\n});\n\nasync function handleFontRequest(request) {\n  const match = await caches.match(request);\n  if (match) return match;\n\n  const [response, fontCache] = await Promise.all([\n    fetch(request),\n    caches.open(fontCacheName)\n  ]);\n\n  fontCache.put(request, response.clone());\n  return response;\n}\n\naddEventListener('fetch', event => {\n  const url = new URL(event.request.url);\n\n  if (url.host == 'fonts.gstatic.com') {\n    event.respondWith(handleFontRequest(event.request));\n    return;\n  }\n  event.respondWith(\n    caches.match(event.request).then(r => r || fetch(event.request))\n  );\n});\n"],"names":["idbKeyval","db","getDB","Promise","resolve","reject","openreq","indexedDB","open","onerror","error","onupgradeneeded","result","createObjectStore","onsuccess","async","withStore","type","callback","transaction","oncomplete","objectStore","key","req","store","get","set","value","put","delete","self","localStorage","getItem","val","setItem","removeItem","version","cachePrefix","staticCacheName","fontCacheName","expectedCaches","addEventListener","event","waitUntil","activeVersionPromise","storage","cache","caches","addAll","activeVersion","split","skipWaiting","cacheName","keys","startsWith","includes","URL","request","url","host","respondWith","match","then","r","fetch","response","fontCache","all","clone","handleFontRequest"],"mappings":"yBAAO,IAAIA,EAAY,MACrB,IAAIC,EAEJ,SAASC,IAmBP,OAlBKD,IACHA,EAAK,IAAIE,SAAQ,CAACC,EAASC,KACzB,MAAMC,EAAUC,UAAUC,KAAK,cAAe,GAE9CF,EAAQG,QAAU,KAChBJ,EAAOC,EAAQI,QAGjBJ,EAAQK,gBAAkB,KAExBL,EAAQM,OAAOC,kBAAkB,WAGnCP,EAAQQ,UAAY,KAClBV,EAAQE,EAAQM,aAIfX,EAGTc,eAAeC,EAAUC,EAAMC,GAC7B,MAAMjB,QAAWC,IACjB,OAAO,IAAIC,SAAQ,CAACC,EAASC,KAC3B,MAAMc,EAAclB,EAAGkB,YAAY,SAAUF,GAC7CE,EAAYC,WAAa,IAAMhB,IAC/Be,EAAYV,QAAU,IAAMJ,EAAOc,EAAYT,OAC/CQ,EAASC,EAAYE,YAAY,cAIrC,MAAO,CACLN,UAAUO,GACR,IAAIC,EAIJ,aAHMP,EAAU,YAAYQ,IAC1BD,EAAMC,EAAMC,IAAIH,MAEXC,EAAIX,QAEbc,IAAG,CAACJ,EAAKK,IACAX,EAAU,aAAaQ,IAC5BA,EAAMI,IAAID,EAAOL,MAGrBO,OAAOP,GACEN,EAAU,aAAaQ,IAC5BA,EAAMK,OAAOP,QAlDE,GA0DlBQ,KAAKvB,YACRP,EAAY,CACVyB,IAAKH,GAAOnB,QAAQC,QAAQ2B,aAAaC,QAAQV,IACjDI,IAAK,CAACJ,EAAKW,IAAQ9B,QAAQC,QAAQ2B,aAAaG,QAAQZ,EAAKW,IAC7DJ,OAAQP,GAAOnB,QAAQC,QAAQ2B,aAAaI,WAAWb,MC1D3D,MAAMc,EAAU,SACVC,EAAc,UACdC,EAAkB,uBAClBC,EAAgB,eAChBC,EAAiB,CAACF,EAAiBC,GAEzCE,iBAAiB,WAAWC,IAC1BA,EAAMC,UAAU,WACd,MAAMC,EAAuBC,EAAQpB,IAAI,kBACnCqB,QAAcC,OAAOvC,KAAK8B,SAE1BQ,EAAME,OAAO,CACjB,KACA,gBACA,UACA,oBACA,aACA,qBACA,oBACA,iBACA,yEAGF,MAAMC,QAAsBL,EAGvBK,GAAiBA,EAAcC,MAAM,KAAK,KAAOd,EAAQc,MAAM,KAAK,IACvEpB,KAAKqB,eApBO,OAyBlBV,iBAAiB,YAAYC,IAC3BA,EAAMC,UAAU,WAEd,IAAK,MAAMS,WAAmBL,OAAOM,OAC9BD,EAAUE,WAAWjB,KACrBG,EAAee,SAASH,UAAkBL,OAAOlB,OAAOuB,UAGzDP,EAAQnB,IAAI,iBAAkBU,IAPtB,OAwBlBK,iBAAiB,SAASC,IAGR,qBAFJ,IAAIc,IAAId,EAAMe,QAAQC,KAE1BC,KAIRjB,EAAMkB,YACJb,OAAOc,MAAMnB,EAAMe,SAASK,MAAKC,GAAKA,GAAKC,MAAMtB,EAAMe,YAJvDf,EAAMkB,YAjBV7C,eAAiC0C,GAC/B,MAAMI,QAAcd,OAAOc,MAAMJ,GACjC,GAAII,EAAO,OAAOA,EAElB,MAAOI,EAAUC,SAAmB/D,QAAQgE,IAAI,CAC9CH,MAAMP,GACNV,OAAOvC,KAAK+B,KAId,OADA2B,EAAUtC,IAAI6B,EAASQ,EAASG,SACzBH,EAOaI,CAAkB3B,EAAMe"}